<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shaka HLS Player (Locked) ¬∑ GH Pages</title>
  <!-- üîí CSP: ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶®‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¶‡¶æ‡¶ì (‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶¨‡¶¶‡¶≤‡¶æ‡¶¨‡ßá) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://www.gstatic.com 'unsafe-inline'; style-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; img-src * data: blob:; media-src https://tataplay.slivcdn.com blob:; connect-src https://tataplay.slivcdn.com 'self'; font-src 'self' https://cdnjs.cloudflare.com; frame-ancestors 'self'; base-uri 'self';" />

  <!-- Shaka Player UI CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.1/controls.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root { --bg:#0b0f17; --panel:#111827; --accent:#6ee7ff; --text:#e5e7eb; --muted:#94a3b8; --rounded:18px; }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#182132 0%,transparent 50%),linear-gradient(180deg,#0b0f17 0%,#0b0f17 100%);color:var(--text);font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(11,15,23,.92),rgba(11,15,23,.65));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    header h1{font-size:16px;margin:0;font-weight:600}
    .btn{border:1px solid rgba(255,255,255,.12);background:#0f172a;color:var(--text);border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
    .wrap{max-width:1100px;margin:18px auto 40px;padding:0 14px}
    .player-card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--rounded);box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:clip}
    .shaka-video-container{aspect-ratio:16/9;background:#0a0e14;position:relative}
    video{width:100%;height:100%;display:block}
    .watermark{position:absolute;right:12px;top:12px;z-index:5;pointer-events:none;font-weight:600;font-size:12px;letter-spacing:.3px;padding:6px 10px;border-radius:999px;color:#0b1324;background:linear-gradient(90deg,#a5f3fc,#93c5fd);opacity:.85;mix-blend-mode:screen;user-select:none}
    .corner-info{position:absolute;left:12px;top:12px;z-index:5;font-size:12px;color:var(--muted)}
    .unmute-overlay{position:absolute;inset:0;display:grid;place-items:center;z-index:6;background:radial-gradient(600px 400px at 50% 50%,rgba(17,24,39,.35),rgba(17,24,39,0));opacity:0;visibility:hidden;transition:.25s ease}
    .unmute-overlay.show{opacity:1;visibility:visible}
    .unmute-btn{padding:12px 16px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:#0f172a;color:var(--text);font-weight:600;cursor:pointer;font-size:14px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .hint{margin:14px 2px;font-size:12px;color:var(--muted)}
    .hint code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;z-index:40;display:none}
    .toast.show{display:block}
    .toast>div{background:#111827;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <h1>Shaka HLS Player <span style="opacity:.6">‚Äî Locked to Allowed URLs</span></h1>
    <div class="actions">
      <button id="btnTheater" class="btn" title="Toggle theater mode (T)">Theater</button>
      <button id="btnReset" class="btn" title="Clear resume point">Reset resume</button>
    </div>
  </header>

  <main class="wrap">
    <div class="player-card">
      <div id="videoContainer" class="shaka-video-container">
        <div class="corner-info" id="cornerInfo"></div>
        <div class="watermark" id="wm">Private</div>
        <div class="unmute-overlay" id="unmute">
          <button class="unmute-btn" id="unmuteBtn">üîä Tap to unmute</button>
        </div>
        <video id="video" autoplay playsinline muted></video>
      </div>
    </div>

    <p class="hint">
      ‡¶è‡¶á ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡¶ü‡¶ø <strong>‡¶π‡ßã‡ßü‡¶æ‡¶á‡¶ü‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶° URL</strong> ‡¶õ‡¶æ‡ßú‡¶æ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶á ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§ <code>allowed.json</code> ‡¶¶‡¶ø‡ßü‡ßá URL ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
    </p>
  </main>

  <div class="toast" id="toast"><div></div></div>

  <!-- Optional: Chromecast sender -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  <!-- Shaka core + UI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.1/shaka-player.compiled.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.1/shaka-player.ui.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
  (function () {
    const qs = new URLSearchParams(location.search);
    const $ = (id) => document.getElementById(id);
    const video = $('video');
    const container = $('videoContainer');
    const wm = $('wm');
    const corner = $('cornerInfo');
    const toast = $('toast');

    // ‚úÖ 1) ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶â-‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ URL ‡¶¨‡¶∏‡¶æ‡¶ì)
    const STATIC_ALLOWED = [
      "https://tataplay.slivcdn.com/hls/live/2020591/TEN3HD/master_664.m3u8"
    ];

    // ‚úÖ 2) allowed.json (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï): repo root-‡¶è ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá ‚Üí {"urls":["https://...m3u8", "..."]}
    async function loadAllowedFromJson(){
      try {
        const r = await fetch('allowed.json', {cache:'no-store'});
        if (!r.ok) return [];
        const j = await r.json();
        return Array.isArray(j.urls) ? j.urls.filter(u => typeof u === 'string') : [];
      } catch (_) { return []; }
    }

    function notify(message, ms = 3000) {
      toast.firstElementChild.textContent = message;
      toast.classList.add('show');
      clearTimeout(notify._t);
      notify._t = setTimeout(() => toast.classList.remove('show'), ms);
    }

    function urlEqual(a, b){
      try { return new URL(a).href === new URL(b).href; } catch { return a === b; }
    }

    function pickManifest(allowedList){
      // src param ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶ø allow list-‡¶è ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶®‡ßá‡¶¨‡ßá, ‡¶®‡¶æ‡¶π‡¶≤‡ßá ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
      const srcParam = qs.get('src');
      if (srcParam){
        const ok = allowedList.some(u => urlEqual(u, srcParam));
        if (!ok){
          throw new Error('URL not allowed by whitelist');
        }
        return srcParam;
      }
      // ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶â URL
      return allowedList[0];
    }

    // UI prefs
    const title = qs.get('title') || 'Private Stream';
    const poster = qs.get('poster');
    const muted = qs.get('muted') === '0' ? false : true; // mobile autoplay safe
    const autoplay = qs.get('autoplay') === '0' ? false : true;
    const startSec = parseFloat(qs.get('start') || '0');
    const watermark = qs.get('wm') || 'Private';
    const resume = qs.get('resume') === '0' ? false : true;

    if (poster) video.setAttribute('poster', poster);
    wm.textContent = watermark;
    document.title = title + ' ¬∑ Shaka HLS Player (Locked)';

    // Unmute overlay
    video.muted = muted;
    const unmuteOverlay = $('unmute');
    const unmuteBtn = $('unmuteBtn');
    function toggleUnmuteOverlay(show){ unmuteOverlay.classList[show?'add':'remove']('show'); }
    if (muted) toggleUnmuteOverlay(true);
    unmuteBtn.addEventListener('click', () => { video.muted = false; toggleUnmuteOverlay(false); });

    // Shaka setup
    shaka.polyfill.installAll();
    if (!shaka.Player.isBrowserSupported()){
      return notify('‡¶è‡¶á ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ Shaka Player ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ. Chrome/Edge/Firefox ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®.', 6000);
    }

    const player = new shaka.Player(video);
    const ui = new shaka.ui.Overlay(player, container, video);
    const controls = ui.getControls();
    ui.configure({
      addSeekBar:true, addBigPlayButton:true, enableTooltips:true,
      controlPanelElements:[ 'play_pause','time_and_duration','spacer','mute','volume','playback_rate','picture_in_picture','airplay','cast','captions','language','quality','fullscreen','overflow_menu' ],
      playbackRates:[0.25,0.5,0.75,1,1.25,1.5,1.75,2,2.5],
      seekBarColors:{ base:'rgba(255,255,255,.25)', buffered:'rgba(255,255,255,.5)', played:'white' },
      statisticsList:['width','height','streamBandwidth','decodedFrames','droppedFrames','playTime','bufferingTime']
    });

    player.configure({
      streaming:{ lowLatencyMode:true, bufferingGoal:1.0, rebufferingGoal:0.5, stallEnabled:true, retryParameters:{ timeout:8000, maxAttempts:3, baseDelay:500 } },
      manifest:{ hls:{ ignoreTextStreamFailures:true, liveSegmentsDelay:3 }, defaultPresentationDelay:3 },
      abr:{ enabled:true, switchInterval:2, defaultBandwidthEstimate:2_500_000 }
    });

    player.addEventListener('error', (e)=> onError(e.detail));
    controls.addEventListener('error', (e)=> onError(e.detail));

    run().catch(onError);

    async function run(){
      // Combine allow lists
      const dynamicList = await loadAllowedFromJson();
      const ALLOWED = Array.from(new Set([...STATIC_ALLOWED, ...dynamicList]));
      if (!ALLOWED.length) throw new Error('No allowed URLs configured');

      const manifestUri = pickManifest(ALLOWED);
      corner.textContent = new URL(manifestUri).hostname + ' ‚Ä¢ locked';

      // Resume position
      const key = 'shaka:resume:' + manifestUri;
      if (resume){
        const t = parseFloat(localStorage.getItem(key) || '0');
        if (t > 5) video.currentTime = t;
        let lastSaved = 0;
        video.addEventListener('timeupdate', ()=>{
          const now = video.currentTime;
          if (Math.abs(now - lastSaved) > 10){ localStorage.setItem(key, String(now)); lastSaved = now; }
        });
      }

      await player.load(manifestUri);
      controls.dispatchEvent(new Event('uiupdated'));

      if (startSec > 0) video.currentTime = startSec;
      if (autoplay){ try { await video.play(); } catch (_) {} }
    }

    function onError(err){
      console.error('Shaka error', err);
      if (err && err.message === 'URL not allowed by whitelist'){
        notify('‚õî ‡¶è‡¶á URL ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á (whitelist mismatch).');
      } else {
        notify('Playback error. ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ CORS/‡¶ü‡ßã‡¶ï‡ßá‡¶®/‡¶ú‡¶ø‡¶ì-‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶á‡¶∏‡ßç‡¶Ø‡ßÅ.', 5000);
      }
    }

    // Shortcuts & buttons
    window.addEventListener('keydown', (e)=>{
      if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      switch(e.key.toLowerCase()){
        case 'k': video.paused ? video.play() : video.pause(); break;
        case 'm': video.muted = !video.muted; break;
        case 'f': ui.getControls().toggleFullScreen(); break;
        case 't': document.getElementById('btnTheater').click(); break;
        case 'arrowleft': video.currentTime = Math.max(0, video.currentTime - 5); break;
        case 'arrowright': video.currentTime = Math.min((video.duration||1), video.currentTime + 5); break;
      }
    });

    $('btnTheater').addEventListener('click', ()=>{ document.documentElement.classList.toggle('theater'); });
    $('btnReset').addEventListener('click', ()=>{ try { localStorage.clear(); notify('Resume data cleared'); } catch(_){} });
  })();
  </script>

  <!--
    üîß ‡¶°‡¶ø‡¶™‡ßç‡¶≤‡ßü ‡¶∏‡ßç‡¶ü‡ßá‡¶™‡¶∏ (GitHub Pages):
    1) ‡¶è‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø repo-‡¶§‡ßá index.html ‡¶®‡¶æ‡¶Æ‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§
    2) ‡¶è‡¶ï‡¶á repo-‡¶§‡ßá (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï) allowed.json ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ø‡ßá‡¶Æ‡¶®:
       {
         "urls": [
           "https://tataplay.slivcdn.com/hls/live/2020591/TEN3HD/master_664.m3u8"
         ]
       }
    3) ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ https://<user>.github.io/<repo>/ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®‡•§
       ‚Ä¢ ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ?src=... ‡¶¶‡¶ø‡¶¨‡ßá‡¶®, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ whitelist-‡¶è ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§

    üõ°Ô∏è ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶®‡ßã‡¶ü:
    ‚Ä¢ ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá CSP ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá, ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ tataplay.slivcdn.com ‡¶è ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶Ø‡¶æ‡ßü‡•§
      ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶®‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá <meta http-equiv="Content-Security-Policy">-‡¶§‡ßá connect-src/media-src ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
    ‚Ä¢ GitHub Pages ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶ï‚Äî‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü ‡¶®‡¶æ‡•§ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ï‡¶°‡¶æ‡¶â‡¶® ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞-‡¶∏‡¶æ‡¶á‡¶° ‡¶∏‡¶æ‡¶á‡¶®‡ßá‡¶ö‡¶æ‡¶∞/‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§

    ‚ö†Ô∏è CORS/Geo/Token:
    ‚Ä¢ ‡¶Ø‡ßá‡¶á HLS ‡¶¶‡ßá‡¶¨‡ßá‡¶® ‡¶∏‡ßá‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá CORS ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá (‡¶¨‡¶æ ‡¶ü‡ßã‡¶ï‡ßá‡¶®/‡¶ú‡¶ø‡¶ì-‡¶¨‡ßç‡¶≤‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá) ‡¶™‡ßç‡¶≤‡ßá ‡¶®‡¶æ‡¶ì ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§
  -->
</body>
</html>
